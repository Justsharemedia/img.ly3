var m="@imgly/plugin-background-removal-web",R=`${m}.canvasMenu`,I=`${R}.button`,E=`${m}.feature`;import v from"lodash/isEqual";function p(e,t,i){e.engine.block.setMetadata(t,m,JSON.stringify(i))}function g(e,t){return e.engine.block.hasMetadata(t,m)?JSON.parse(e.engine.block.getMetadata(t,m)):{status:"IDLE"}}function D(e,t){e.engine.block.hasMetadata(t,m)&&e.engine.block.removeMetadata(t,m)}function N(e,t,i){if(!e.engine.block.isValid(t)||i.status==="IDLE"||i.status==="PENDING"||i.status==="ERROR"||!e.engine.block.hasFill(t))return!1;let n=e.engine.block.getFill(t);return!(i.blockId===t||i.fillId===n)}function U(e,t){let i=e.engine.block.getFill(t),n=g(e,t);n.status==="IDLE"||n.status==="PENDING"||n.status==="ERROR"||p(e,t,{...n,blockId:t,fillId:i})}function d(e,t){if(!e.engine.block.isValid(t))return!1;let i=g(e,t);if(i.status==="IDLE"||i.status==="PENDING")return!0;if(!e.engine.block.hasFill(t))return!1;let n=e.engine.block.getFill(t);if(n==null||t!==i.blockId||n!==i.fillId)return!1;let r=e.engine.block.getSourceSet(n,"fill/image/sourceSet"),a=e.engine.block.getString(n,"fill/image/imageFileURI");if(r.length===0&&!a&&i.status==="PROCESSING")return!0;if(r?.length>0){let l=i.initialSourceSet;if(i.status==="PROCESSED"){let u=i.removedBackground;if(!v(r,u)&&!v(r,l))return!1}else if(!v(r,l))return!1}else if(i.status==="PROCESSED"){if(a!==i.initialImageFileURI&&a!==i.removedBackground)return!1}else if(a!==i.initialImageFileURI)return!1;return!0}function b(e,t){if(!e.engine.block.hasFill(t))return;let n=g(e,t);if(n.status==="PENDING"||n.status==="IDLE")return;let r=n.initialSourceSet,a=n.initialImageFileURI,l=n.initialPreviewFileURI,u=G(e,t,n);u!=null&&(a&&e.engine.block.setString(u,"fill/image/imageFileURI",a),l&&e.engine.block.setString(u,"fill/image/previewFileURI",l),r.length>0&&e.engine.block.setSourceSet(u,"fill/image/sourceSet",r))}function G(e,t,i){if(!e.engine.block.isValid(t)||!e.engine.block.hasFill(t)||t!==i.blockId)return;let n=e.engine.block.getFill(t);if(n===i.fillId)return n}function h(e){e.feature.unstable_enable(E,({engine:t})=>{let i=t.block.findAllSelected();if(i.length!==1)return!1;let[n]=i;if(e.engine.block.hasFill(n)){let r=e.engine.block.getFill(n);if(e.engine.block.getType(r)!=="//ly.img.ubq/fill/image")return!1;let l=t.block.getString(r,"fill/image/imageFileURI");return t.block.getSourceSet(r,"fill/image/sourceSet").length>0||l!==""?!0:g(e,n).status==="PROCESSING"}return!1})}import{applySegmentationMask as w,segmentForeground as B}from"@imgly/background-removal";import A from"lodash/throttle";async function F(e,t,i){let n=e.engine.block;if(!n.hasFill(t))throw new Error("Block has no fill to remove the background from");let r=n.getFill(t),a=n.getSourceSet(r,"fill/image/sourceSet"),l=n.getString(r,"fill/image/imageFileURI"),u=n.getString(r,"fill/image/previewFileURI");try{n.setString(r,"fill/image/imageFileURI",""),n.setSourceSet(r,"fill/image/sourceSet",[]);let o=g(e,t);p(e,t,{...o,version:"0.2.0",initialSourceSet:a,initialImageFileURI:l,initialPreviewFileURI:u,blockId:t,fillId:r,status:"PROCESSING"});let f=a.length>0?a.sort((s,c)=>c.width*c.height-s.height*s.width)[0].uri:l;u||n.setString(r,"fill/image/previewFileURI",f);let S=await B(f,i);if(a.length>0){let s=await O(e,t,a,S,i);if(s==null)return;if(s.every(P=>P==null))throw new Error("Could not upload any BG removed image");let c=a.map((P,C)=>({...P,uri:s[C]}));p(e,t,{version:"0.2.0",initialSourceSet:a,initialImageFileURI:l,initialPreviewFileURI:u,blockId:t,fillId:r,status:"PROCESSED",removedBackground:c}),n.setSourceSet(r,"fill/image/sourceSet",c),n.setString(r,"fill/image/previewFileURI","")}else{let s=await O(e,t,[{uri:f}],S,i);if(s==null)return;let c=s[0];if(c==null)throw new Error("Could not upload BG removed image");p(e,t,{version:"0.2.0",initialSourceSet:a,initialImageFileURI:l,initialPreviewFileURI:u,blockId:t,fillId:r,status:"PROCESSED",removedBackground:c}),n.setString(r,"fill/image/imageFileURI",c),n.setString(r,"fill/image/previewFileURI","")}e.engine.editor.addUndoStep()}catch(o){e.engine.block.isValid(t)&&(p(e,t,{version:"0.2.0",initialSourceSet:a,initialImageFileURI:l,initialPreviewFileURI:u,blockId:t,fillId:r,status:"ERROR"}),b(e,t)),console.log(o)}}async function O(e,t,i,n,r){let a={...r,progress:A((o,f,S)=>{let s=g(e,t);s.status!=="PROCESSING"||!d(e,t)||(r.progress?.(o,f,S),p(e,t,{...s,progress:{key:o,current:f,total:S}}))},100)},l=await Promise.all(i.map(async o=>[await w(o.uri,n,a),o]));if(g(e,t).status!=="PROCESSING"||!d(e,t))return;let u=await Promise.all(l.map(async([o,f])=>{let s=new URL(f.uri).pathname.split("/"),c=s[s.length-1],C=(await e.unstable_upload(new File([o],c,{type:o.type}),()=>{})).meta?.uri;if(C==null)throw new Error("Could not upload BG removed image");return[C,f]}));if(!(g(e,t).status!=="PROCESSING"||!d(e,t)))return u.map(([o])=>o)}var M=`plugin.${m}.action.removeBackground`;function _(e,t={}){T("canvasMenu",t)&&e.ui.unstable_setCanvasMenuOrder([R,...e.ui.unstable_getCanvasMenuOrder()]),e.setTranslations({en:{[M]:"BG Removal"}}),e.ui.unstable_registerComponent(R,({builder:{Button:i},engine:n})=>{if(!e.feature.unstable_isEnabled(E,{engine:n}))return;let[r]=n.block.findAllSelected(),a=g(e,r),l=a.status==="PROCESSING",u=a.status==="PENDING"||a.status==="PROCESSING",o;if(l&&a.progress){let{key:f,current:S,total:s}=a.progress;f==="compute:inference"?o=void 0:f.startsWith("fetch:/models/")?o=S/s*50:f.startsWith("fetch:/onnxruntime-web/")?o=50+S/s*50:o=void 0}i(I,{label:M,icon:"@imgly/icons/BGRemove",isLoading:l,isDisabled:u,loadingProgress:o,onClick:()=>{(a.status==="IDLE"||a.status==="ERROR"||a.status==="PROCESSED")&&p(e,r,{status:"PENDING"})}})})}function T(e,t){return t.locations&&(Array.isArray(t.locations)?t.locations:[t.locations]).includes(e)}var y=(e={})=>{let t=e?.backgroundRemoval??{};return{initialize(){},update(){},initializeUserInterface({cesdk:i}){i.engine.event.subscribe([],async n=>{n.forEach(r=>{let a=r.block;if(!(!i.engine.block.isValid(a)||!i.engine.block.hasMetadata(a,m)))if(r.type==="Created"){let l=g(i,a);N(i,a,l)&&U(i,a)}else r.type==="Updated"&&x(i,a,t)})}),_(i,e.ui),h(i)}}};async function x(e,t,i){switch(g(e,t).status){case"PENDING":{e.feature.unstable_isEnabled(E,{engine:e.engine})&&F(e,t,i);break}case"PROCESSING":case"PROCESSED":{d(e,t)||D(e,t);break}default:}}var K=e=>({name:m,version:"0.2.0",...y(e)}),se=K;export{se as default};
//# sourceMappingURL=index.mjs.map
